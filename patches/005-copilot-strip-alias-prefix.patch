# PATCH 005: Strip copilot- alias prefix in upstream requests
#
# When models are registered via oauth-model-alias with fork:true and a
# copilot- prefix (e.g., copilot-gpt-5.2 -> gpt-5.2), the alias name
# is used as req.Model throughout the proxy. However, GitHub Copilot's
# upstream API only recognizes the original model name (gpt-5.2), not
# the aliased name (copilot-gpt-5.2).
#
# This patch updates normalizeModel to also strip the copilot- prefix
# from the model field in the JSON payload before sending to upstream.
#
# Apply AFTER 002-copilot-claude-endpoint.patch.
--- a/internal/runtime/executor/github_copilot_executor.go
+++ b/internal/runtime/executor/github_copilot_executor.go
@@ -540,11 +540,14 @@
 	return false
 }
 
-// normalizeModel strips the suffix (e.g. "(medium)") from the model name
-// before sending to GitHub Copilot, as the upstream API does not accept
-// suffixed model identifiers.
+// normalizeModel strips the suffix (e.g. "(medium)") and the "copilot-" alias
+// prefix from the model name before sending to GitHub Copilot, as the upstream
+// API does not accept suffixed or prefixed model identifiers.
 func (e *GitHubCopilotExecutor) normalizeModel(model string, body []byte) []byte {
 	baseModel := thinking.ParseSuffix(model).ModelName
+	if strings.HasPrefix(baseModel, "copilot-") {
+		baseModel = strings.TrimPrefix(baseModel, "copilot-")
+	}
 	if baseModel != model {
 		body, _ = sjson.SetBytes(body, "model", baseModel)
 	}
