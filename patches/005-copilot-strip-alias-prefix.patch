From: CLI Proxy Custom Patches
Subject: [PATCH 005] Strip copilot- alias prefix in upstream requests

When models are registered via oauth-model-alias with fork:true and a
copilot- prefix (e.g., copilot-gpt-5.2 -> gpt-5.2), the alias name
is used as req.Model throughout the proxy. However, GitHub Copilot's
upstream API only recognizes the original model name (gpt-5.2), not
the aliased name (copilot-gpt-5.2).

This patch updates normalizeModel to strip the copilot- prefix from
the model field in the JSON payload before sending to upstream.

This patch should be applied AFTER 002-copilot-claude-endpoint.patch.

---
diff --git a/internal/runtime/executor/github_copilot_executor.go b/internal/runtime/executor/github_copilot_executor.go
--- a/internal/runtime/executor/github_copilot_executor.go
+++ b/internal/runtime/executor/github_copilot_executor.go
@@ -473,9 +473,16 @@ func detectVisionContent(body []byte) bool {
 	return false
 }
 
-// normalizeModel is a no-op as GitHub Copilot accepts model names directly.
-// Model mapping should be done at the registry level if needed.
-func (e *GitHubCopilotExecutor) normalizeModel(_ string, body []byte) []byte {
+// normalizeModel strips the "copilot-" alias prefix from the model field
+// in the request payload. When oauth-model-alias creates forked models
+// (e.g., copilot-gpt-5.2 from gpt-5.2), the alias name flows through as
+// req.Model. GitHub Copilot's upstream API only accepts the original name.
+func (e *GitHubCopilotExecutor) normalizeModel(model string, body []byte) []byte {
+	if strings.HasPrefix(model, "copilot-") {
+		upstream := strings.TrimPrefix(model, "copilot-")
+		body, _ = sjson.SetBytes(body, "model", upstream)
+		return body
+	}
 	return body
 }
 
